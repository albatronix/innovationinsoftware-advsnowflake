--Data Governance
--Lab 5.1

-- Create sample databases

USE ROLE ACCOUNTADMIN;

CREATE OR REPLACE DATABASE SNOWTEST; -- Database storing the tags
CREATE OR REPLACE DATABASE SNOWTEST2;
CREATE OR REPLACE DATABASE SNOWTEST3;

-- We need to create a schema for the object tags

CREATE OR REPLACE SCHEMA SNOWTEST.TAGS;

-- Let's create a tag for the different database objects

CREATE OR REPLACE TAG SNOWTEST.TAGS.tag_options allowed_values 'sales','finance';

-- We can look at the tags
SELECT GET_DDL('tag', 'tag_options');

-- We can Tag objects by using the ALTER command and SET TAG

ALTER DATABASE SNOWTEST2 SET TAG tag_options = 'sales';

-- We can ONLY add tags where there is an available option

ALTER DATABASE SNOWTEST3 SET TAG tag_options = 'IT'; -- Should display an error

-- ALTER the Tag to add the IT Option

ALTER TAG SNOWTEST.TAGS.tag_options add allowed_values 'IT';
ALTER DATABASE SNOWTEST3 SET TAG SNOWTEST.TAGS.tag_options = 'IT';

-- We can always see all the available options for a tag in Snowflake

SELECT SYSTEM$GET_TAG_ALLOWED_VALUES('SNOWTEST.TAGS.TAG_OPTIONS');

-- Furthermore, we can see what objects have various tags
--Clean up

DROP DATABASE SNOWTEST;
DROP DATABASE SNOWTEST3;
DROP DATABASE SNOWTEST3;


--Lab 5.2
-- Create a sample data and table with ID, Social Security number, Age and Credit Card

USE ROLE ACCOUNTADMIN;

CREATE OR REPLACE DATABASE SNOWTEST;
CREATE OR REPLACE SCHEMA SNOWTEST.DATA_CLASS;
CREATE OR REPLACE TABLE SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL(
    ID VARCHAR(10)
    , SSN VARCHAR(11) 
    , AGE NUMERIC 
    , CREDIT_CARD VARCHAR(19) 
);


-- Let's enter some fake sensitive data
INSERT INTO SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL 
VALUES ('A0000001','234-45-6477',24,'4053-0495-0394-0494'),
('A0000002','234-85-3427',28,'4653-0495-0394-0494'),
('A0000003','235-49-6477',43,'4053-0755-0394-0494'),
('A0000004','254-85-6457',57,'4653-4566-0394-0494'),
('A0000005','235-45-6076',34,'4053-0755-0394-0494'),
('A0000006','454-85-6473',21,'4653-0495-0394-0494'),
('A0000008','285-49-6697',17,'4053-0755-0394-0494'),
('A0000009','234-85-7377',12,'4653-0495-0394-0494'),
('A0000010','253-45-6467',87,'4053-0755-0394-0494'),
('A0000012','434-85-6384',58,'4653-0495-0394-0494'),
('A0000013','893-45-4266',34,'4053-0755-0394-0494'),
('A0000011','684-85-9405',74,'4653-0495-3454-0494'),
('A0000014','345-45-6935',28,'4053-0755-0394-0494'),
('A0000015','034-85-6637',53,'4653-0495-0394-0494'),
('A0000016','475-45-5646',34,'4053-0755-0394-0494'),
('A0000017','694-85-6030',38,'4653-0495-0394-0494'),
('A0000018','745-45-5466',36,'4053-0755-0394-0494'),
('A0000019','224-85-3246',74,'4653-0495-0394-0494'),
('A0000020','945-45-9645',45,'4053-0755-0394-0494');

-- Looking at the table values
SELECT *
FROM SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL;

-- Run EXTRACT_SEMANTIC_CATEGORIES to analyze the columns in the table
SELECT EXTRACT_SEMANTIC_CATEGORIES('SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL');

-- The results will be in JSON format. We can flatten to analysis the recommendations

CREATE OR REPLACE TABLE SNOWTEST.DATA_CLASS.CLASSIFICATIONS AS
select t.key::varchar as column_name,
    t.value:"recommendation".privacy_category::varchar as privacy_category,  
    t.value:"recommendation".semantic_category::varchar as semantic_category,
    t.value:"recommendation".coverage::numeric as probability
from table(
        flatten(
            extract_semantic_categories(
                'SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL'
            )::variant
        )
    ) as t
;

-- We can then use this table to review the recommendation and create object tags accordingly
SELECT * FROM SNOWTEST.DATA_CLASS.CLASSIFICATIONS;


DROP DATABASE SNOWTEST;


--Lab 5.3
-- Create a sample data and table with ID, Social Security number, Age and Credit Card

USE ROLE ACCOUNTADMIN;

CREATE OR REPLACE DATABASE SNOWTEST;
CREATE OR REPLACE SCHEMA SNOWTEST.DATA_CLASS;
CREATE OR REPLACE TABLE SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL(
    ID VARCHAR(10)
    , SSN VARCHAR(11) 
    , AGE NUMERIC 
    , CREDIT_CARD VARCHAR(19) 
);

-- Let's enter some fake sensitive data

INSERT INTO SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL 
VALUES ('A0000001','234-45-6477',24,'4053-0495-0394-0494'),
('A0000002','234-85-3427',28,'4653-0495-0394-0494'),
('A0000003','235-49-6477',43,'4053-0755-0394-0494'),
('A0000004','254-85-6457',57,'4653-4566-0394-0494'),
('A0000005','235-45-6076',34,'4053-0755-0394-0494'),
('A0000006','454-85-6473',21,'4653-0495-0394-0494'),
('A0000008','285-49-6697',17,'4053-0755-0394-0494'),
('A0000009','234-85-7377',12,'4653-0495-0394-0494'),
('A0000010','253-45-6467',87,'4053-0755-0394-0494'),
('A0000012','434-85-6384',58,'4653-0495-0394-0494'),
('A0000013','893-45-4266',34,'4053-0755-0394-0494'),
('A0000011','684-85-9405',74,'4653-0495-3454-0494'),
('A0000014','345-45-6935',28,'4053-0755-0394-0494'),
('A0000015','034-85-6637',53,'4653-0495-0394-0494'),
('A0000016','475-45-5646',34,'4053-0755-0394-0494'),
('A0000017','694-85-6030',38,'4653-0495-0394-0494'),
('A0000018','745-45-5466',36,'4053-0755-0394-0494'),
('A0000019','224-85-3246',74,'4653-0495-0394-0494'),
('A0000020','945-45-9645',45,'4053-0755-0394-0494');

-- Here is the table, but we have senstive data like SSN and Credit Card information
SELECT * FROM SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL;

-- We want to mask the social security number so it only shows the last 4 digits
SELECT CONCAT('XXX-XX-',RIGHT(SSN,4)) as SSN
FROM SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL;-

-- Create a analyst role

CREATE OR REPLACE ROLE analyst;

GRANT ROLE analyst TO USER <user>;

GRANT ALL ON WAREHOUSE COMPUTE_WH TO ROLE analyst;
GRANT ALL ON DATABASE SNOWTEST TO ROLE analyst;
GRANT ALL ON SCHEMA SNOWTEST.DATA_CLASS TO ROLE analyst;
GRANT ALL ON TABLE SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL TO ROLE analyst;

-- Create masking policy for SSN number
CREATE OR REPLACE MASKING POLICY ssn_mask AS (val string) RETURNS string ->
  CASE
    WHEN CURRENT_ROLE() = 'ANALYST' THEN val
    ELSE CONCAT('XXX-XX-',RIGHT(val,4))
  END;

  
-- Now apply the masking policy on the sample table SSN column
ALTER TABLE IF EXISTS SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL MODIFY COLUMN SSN SET MASKING POLICY ssn_mask;

-- using the ANALYST role

USE ROLE analyst;
SELECT CURRENT_ROLE();
SELECT * FROM SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL; -- should see plain text value

-- using the ACCOUNTADMIN role

USE ROLE ACCOUNTADMIN;
SELECT * FROM SNOWTEST.DATA_CLASS.SAMPLE_DATA_TBL; -- should see full data mask

-- Clear resources

USE ROLE ACCOUNTADMIN;
DROP DATABASE SNOWTEST;
DROP ROLE ANALYST;

-- Test Your Skills

-- Create three new roles, administration, enrollment and accounting
-- Create a masking policy so that SSN and Credit Card is masked for administration, credit card is masked for enrollment and SSN is masked for finance

--Lab 5.4


-- Create new database

USE ROLE ACCOUNTADMIN;

CREATE OR REPLACE DATABASE SNOWTEST;
CREATE OR REPLACE SCHEMA SNOWTEST.PUBLIC;

-- Create roles and apply to the user

CREATE OR REPLACE ROLE ROLE1;
CREATE OR REPLACE ROLE ROLE2;
CREATE OR REPLACE ROLE ROLE3;
CREATE OR REPLACE ROLE SUPERADMIN;

GRANT ROLE SUPERADMIN TO USER <user>;
GRANT ROLE ROLE1 TO USER <user>;
GRANT ROLE ROLE2 TO USER <user>;
GRANT ROLE ROLE3 TO USER <user>;

-- We will create a new table of start, social security, age, CC

CREATE OR REPLACE TABLE SNOWTEST.PUBLIC.SAMPLE_DATA_TBL(
    STATE VARCHAR(2)
    , SSN VARCHAR(11)
    , AGE NUMERIC
    , CC VARCHAR(19)
);

INSERT INTO SNOWTEST.PUBLIC.SAMPLE_DATA_TBL 
VALUES ('KS','234-45-6477',27,'4053 0495 0394 0494'), 
('TX','234-85-6477',67,'4653 0495 0394 0494'), 
('TX','235-45-6477',44,'4053 0755 0394 0494'), 
('MD','234-85-6477',81,'4873 0495 0394 4094'), 
('CA','234-85-0877',18,'4653 0495 0084 0494');

-- Create a mapping table for row-level access

CREATE OR REPLACE TABLE SNOWTEST.PUBLIC.MAPPING (
    ROLE_ENTITLED varchar, STATE varchar
);

-- Insert mapping values

INSERT INTO SNOWTEST.PUBLIC.MAPPING VALUES ('ROLE1','TX'),
('ROLE1','KS'),
('ROLE1','MD'),
('ROLE1','CA'),
('ROLE1','TX'),
('ROLE1','MA'),
('ROLE3','TX'),
('ROLE3','KS');

-- Create row access policy

CREATE ROW ACCESS POLICY SNOWTEST.PUBLIC.TEST_POLICY AS
(state_filter varchar) RETURNS BOOLEAN ->  -- This will provide a true or false on the row based on the mapping table
CURRENT_ROLE() = 'SUPERADMIN'
OR EXISTS (
    SELECT 1 FROM SNOWTEST.PUBLIC.MAPPING
    WHERE STATE = state_filter
    AND ROLE_ENTITLED = CURRENT_ROLE());

-- Apply the row access policy on the created table

ALTER TABLE SNOWTEST.PUBLIC.SAMPLE_DATA_TBL ADD ROW ACCESS POLICY SNOWTEST.PUBLIC.TEST_POLICY ON (STATE);

-- Grant permissions to all of the roles

USE ROLE ACCOUNTADMIN;
GRANT SELECT ON SNOWTEST.PUBLIC.SAMPLE_DATA_TBL TO ROLE ROLE1;
GRANT SELECT ON SNOWTEST.PUBLIC.SAMPLE_DATA_TBL TO ROLE ROLE2;
GRANT SELECT ON SNOWTEST.PUBLIC.SAMPLE_DATA_TBL TO ROLE ROLE3;
GRANT SELECT ON SNOWTEST.PUBLIC.SAMPLE_DATA_TBL TO ROLE SUPERADMIN;

GRANT ALL ON WAREHOUSE COMPUTE_WH TO ROLE ROLE1;
GRANT ALL ON DATABASE SNOWTEST TO ROLE ROLE1;
GRANT ALL ON SCHEMA SNOWTEST.PUBLIC TO ROLE ROLE1;

GRANT ALL ON WAREHOUSE COMPUTE_WH TO ROLE ROLE2;
GRANT ALL ON DATABASE SNOWTEST TO ROLE ROLE2;
GRANT ALL ON SCHEMA SNOWTEST.PUBLIC TO ROLE ROLE2;

GRANT ALL ON WAREHOUSE COMPUTE_WH TO ROLE ROLE3;
GRANT ALL ON DATABASE SNOWTEST TO ROLE ROLE3;
GRANT ALL ON SCHEMA SNOWTEST.PUBLIC TO ROLE ROLE3;

GRANT ALL ON WAREHOUSE COMPUTE_WH TO ROLE SUPERADMIN;
GRANT ALL ON DATABASE SNOWTEST TO ROLE SUPERADMIN;
GRANT ALL ON SCHEMA SNOWTEST.PUBLIC TO ROLE SUPERADMIN;

-- Test the access by role

USE ROLE SUPERADMIN;
SELECT CURRENT_ROLE();
SELECT * FROM SNOWTEST.PUBLIC.SAMPLE_DATA_TBL;

USE ROLE ROLE1;
SELECT CURRENT_ROLE();
SELECT * FROM SNOWTEST.PUBLIC.SAMPLE_DATA_TBL;

USE ROLE ROLE2;
SELECT CURRENT_ROLE();
SELECT * FROM SNOWTEST.PUBLIC.SAMPLE_DATA_TBL;

USE ROLE ROLE3;
SELECT CURRENT_ROLE();
SELECT * FROM SNOWTEST.PUBLIC.SAMPLE_DATA_TBL;

USE ROLE ACCOUNTADMIN;

-- Clear resources

USE ROLE ACCOUNTADMIN;

DROP DATABASE SNOWTEST;
DROP ROLE ROLE1;
DROP ROLE ROLE2;
DROP ROLE ROLE3;
DROP ROLE SUPERADMIN;

-- Test Your Skills

-- Use the below 

CREATE OR REPLACE DATABASE SNOWTEST;
CREATE OR REPLACE SCHEMA SNOWTEST.PUBLIC;

CREATE OR REPLACE TABLE SNOWTEST.PUBLIC.SAMPLE_DATA_TBL(
    ID VARCHAR(5)
    , ANIMAL VARCHAR(10)
    , PASSWORD VARCHAR(10)
    , REGION VARCHAR(2)
);

INSERT INTO SNOWTEST.PUBLIC.SAMPLE_DATA_TBL 
VALUES ('A0001','Dog','DDKe43##@','N'),('A0002','Cat','24454##@','S'),('A0003','Mouse','334452552@','N'),('A0004','Pig','JILL12345','N'),('A0005','Dog','PASS321','W'),('A0006','Dog','LMONKEY','E'),('A0007','Horse','JILL12345','S'),('A0008','Cat','whisker@$','W'),('A0009','Dog','Melon','N')
;

SELECT *
FROM SNOWTEST.PUBLIC.SAMPLE_DATA_TBL
;

-- Using row access policies and masking, make it such that the password is masked from everyone, TeamA can only see regions 'N' and 'S', TeamB can see everything, TeamC can only see the region W and has everything by ID masked and TeamD can only see dogs

